#cloud-config

users:
- name: thor-worker
  uid: 2000

write_files:
- path: /etc/systemd/system/thor-worker.service
  permissions: 0644
  owner: root
  content: |
    [Unit]
    Description=THOR Autoscaler
    Wants=gcr-online.target
    After=gcr-online.target

    [Service]
    Restart=always
    Environment="HOME=/home/thor-autoscaler"
    ExecStartPre=/usr/bin/docker-credential-gcr configure-docker && \
        docker pull gcr.io/moeyens-thor-dev/thor-autoscaler:production-latest
    ExecStart=/usr/bin/docker run --rm \
                        --name thor-autoscaler \
                        --net=host \
                        --env THOR_AUTOSCALED_QUEUES=production-tasks \
                        gcr.io/moeyens-thor-dev/thor-autoscaler:production-latest production-tasks
    ExecStop=/usr/bin/docker stop thor-worker
    ExecStopPost=/usr/bin/docker rm thor-worker

    [Install]
    WantedBy=multi-user.target

runcmd:
- systemctl daemon-reload
- systemctl start thor-worker.service
